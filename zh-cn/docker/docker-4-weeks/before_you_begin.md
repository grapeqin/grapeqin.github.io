# 1 开始之前

Docker是个让应用能以容器(轻量级单元)运行的平台。从云中的无服务器架构到企业的战略规划，容器无处不在。Docker正成为整个行业中运维、开发人员的核心竞争力–在最新的Stack Overflow调查中，Docker在大家最想学的技术中排名第1位。

Docker是一门易于学习的技术。您完全可以作为一名初学者来阅读这本书，您将在第2章开始运行容器，在第3章中打包能在Docker中运行的应用程序。每章都会注重实操，提供适用于任何运行Docker的计算机上的示例和实验–欢迎使用Windows，Mac和Linux的用户。

这本书来源于我多年教学经验的积累。除本章外，每章都需要动手操作。在开始学习Docker之前，了解容器在现实世界中的使用方式以及搞清楚容器解决问题的类型非常重要，这也是我在本章将要介绍的内容。本章还将介绍我会如何讲解Docker，借此可以判断这本书是否适合您。

下面我将一一介绍企业运用Docker的5个典型场景。您将看到容器能够解决的各类问题，其中有一些在您的工作中一定会遇到。在本章结尾，您将明白为什么要学Docker，以及本书如何帮您学习Docker。

## 1.1 为什么容器会风靡全球

我的Docker之旅始于2014年，当时我从事一个为Android设备提供API的项目。我们开始使用Docker作为开发工具–源代码和构建服务器。在这个过程中我们获得了信心，并开始在测试环境中以容器来运行API。在项目结束时，即使我们对生产环境的可用性和规模有严格的要求，所有环境都由Docker提供支持。

当我离开项目时，移交给新团队的只有GitHub仓库中的一个README文件。只需要安装Docker就可以在任何环境下构建，部署和管理应用程序。新开发人员只需获取源代码并运行一个命令即可在本地构建和运行所有内容。管理员使用同样的工具在生产集群中部署和管理容器。

通常，在这种规模的项目上，移交需要两个星期。新开发人员需要安装多种特定版本的工具，而管理员需要安装多种完全不同的工具。Docker支持工具链，让每个人的工作变得如此简单，以至于我认为未来有一天每个项目都必须使用容器。

我于2016年加入Docker，最近几年我一直在看着这一愿景逐渐变为现实。Docker的普及，部分原因是它使交付变得如此容易，另一方面是因为它如此灵活–您可以将其带入Windows和Linux的所有新老项目中。让我们看一下容器适合那些场景。

### 1.1.1 应用迁移到云端

对于许多企业来说，应用迁移到云端势在必行。这是一个非常有吸引力的选择–让Microsoft或Amazon或Google去操心服务器，磁盘，网络和电源。将应用程序托管在拥有几乎无限扩展潜力的全球数据中心中。只需要数分钟即可将应用部署到新环境，并且仅根据使用的资源数量进行计费。但是，如何将应用程序迁移到云端？

应用程序迁移到云端有两种方案：基础架构即服务（IaaS）和平台即服务（PaaS）。这两种方案都不是很好。任何一个都是妥协后的方案–选择PaaS意味着要将应用程序的所有部分迁移到相关的云托管服务。这是一项艰巨的任务，它将您限制在单个云服务商中，但确实可以降低运行成本。另一种选择是IaaS，您可以为应用程序的每个组件单独启动虚拟机。您可以跨云移植，但运行成本更高。图1.1显示了使用IaaS和PaaS进行云迁移时典型的分布式应用程序的外观。

**图1.1迁移到云的原始选项-使用IaaS并运行许多低效率的VM，每月费用较高，或者使用PaaS并获得较低的运行成本，但花更多的时间进行迁移**

![img](https://dpzbhybb2pdcj.cloudfront.net/stoneman/v-7/Figures/Images_01-03_1.jpg)

Docker提供了第三种选择，且没有妥协。可以将应用程序的每一部分迁移到容器，然后使用Azure Kubernetes Service、Amazon的Elastic Container Service或自己数据中心的Docker群集在容器中运行整个应用程序。您将在第7章中学习如何在容器中打包和运行分布式应用程序，并在第13和14章中学习如何在大规模生产中运行分布式应用程序。图1.2显示了Docker方案，它为您提供了可移植的应用程序，您可以在任何云端、数据中心或便携式计算机中以低成本运行。

**图1.2在迁移到云之前，同一应用已迁移到Docker。该应用程序具有PaaS的成本优势，IaaS的可移植性优势以及仅通过Docker获得的易用性**

![img](https://dpzbhybb2pdcj.cloudfront.net/stoneman/v-7/Figures/Images_01-03_2.jpg)

应用迁移到容器确实需要耗费一些心血，但主要是按照Docker Compose或Kubernetes要求的格式将现有安装步骤构建到名为Dockerfiles的脚本中，并将部署文档构建到应用程序描述性清单中。您无需更改代码，就可以在包括笔记本电脑到云端的每个环境中使用相同的技术栈以相同的方式运行。

### 1.1.2 旧应用改造成现代化架构

您可以在容器中运行任何应用程序，但如果是单一应用的架构，将无法获得Docker或云平台的全部价值。单一应用在容器中能够正常工作，但它限制了应用的敏捷性。您使用容器能在30秒内在生产环境推出一项新功能。但如果该功能是由两百万行代码构建的单一应用的一部分，那么在发布之前，可能必须经历两个星期的回归测试周期。

将应用程序迁移到Docker是现代化架构的第一步，采用新模式无需完全重写应用程序。方法其实很简单–使用将在本书中学习的Dockerfile和Docker Compose语法将应用程序移动到单个容器中。这样，容器中就有了一个完整的应用。

容器在自己的虚拟网络中运行，因此它们可以相互通信而不会暴露给外界。这意味着可以分解应用程序，将不同的特性移动到它自己的容器中，这样，单一应用就逐渐演变成一个分布式应用程序，整个功能集由多个容器提供。图1.3显示了使用示例应用程序体系结构的外观。

**图1.3将整体分解为分布式应用程序，而无需重写整个项目。所有组件都在Docker容器中运行，而路由组件则决定是由整体还是新的微服务来满足请求。**

![img](https://dpzbhybb2pdcj.cloudfront.net/stoneman/v-7/Figures/Images_01-03_3.jpg)

微服务架构带来了许多好处。最主要的特性是所有的组件位于独立的小型单元中，可以对它们进行独立管理。这意味着您可以快速测试更改，因为无需更改整个应用，只需更改运行相关功能的容器即可。可以运用扩容缩容特性，也可以选择不同的技术来满足需求。

使用Docker可以轻松实现旧架构应用程序的架构升级–您将在第20章和第21章中的实际示例中自行完成。您将分阶段提供一个更加敏捷，可扩展且更具弹性的应用程序，而不必停下来花费18个月重写应用。

### 1.1.3 构建云原生应用

Docker可以帮助您将现有应用程序发布到云中，无论它们是分布式应用程序还是单一架构应用程序。如果您的应用属于单一架构应用，无论它运行在云端或数据中心，Docker都可以帮助将它们分解为分布式架构。借助Docker，基于云原生的项目得到了极大的加速。

在[Cloud Native Computing Foundation (CNCF)](https://www.cncf.io/)这样描述这种新的架构：”一种将应用程序部署为微服务的开源技术，把应用的各个部分打包到容器中，通过动态编排这些容器来优化资源利用”。

图1.4展示了新微服务应用程序的典型架构–这是一个来自社区的演示应用程序，您可以在GitHub上的https://github.com/microservices-demo上找到它：

**图1.4云本机应用程序是使用微服务架构构建的，其中每个组件都在容器中运行**

![img](https://dpzbhybb2pdcj.cloudfront.net/stoneman/v-7/Figures/Images_01-03_4.jpg)

如果您想了解微服务的具体实现方式，它是一个很好的示例应用程序。每个组件都有自己的数据存储，通过API暴露服务。前端是使用各个组件提供的API服务形成的Web应用程序。该演示程序使用不同编程语言和不同的数据库技术。每个组件都有一个用于打包的Dockerfile，整个应用程序都在Docker Compose文件中定义。

作为打包应用程序的一个环节，您将在第4章中学习如何使用Docker编译代码。这意味着您不需要安装任何开发工具即可构建和运行应用程序。开发人员只需安装Docker，克隆源代码，并使用一个命令即可构建和运行整个应用程序。

Docker还可以轻松地将第三方软件引入您的应用程序，无需自己编写代码即可添加功能。Docker Hub是一项公共服务，团队可以在它上面共享容器中运行的软件。CNCF发布了一个开源项目地图，您可以使用包括监控到消息队列的所有软件，并且它们都可以从Docker Hub免费获得。

### 1.1.4 技术创新-无服务器架构

现代化IT的主要推动力之一是一致性：团队希望为所有项目使用相同的工具，流程和运行时环境。使用Docker可以做到这一点，使用容器处理Windows上运行的旧.NET应用、Linux上运行的新Go应用程序等所有内容。您可以构建一个Docker集群来运行所有这些应用程序，从而以相同的方式构建，部署和管理整个应用程序格局。

技术创新不能脱离于业务-通常意义上的普通应用程序。Docker是一些重大创新的核心，因此您在探索新领域时可以继续使用相同的工具和技术。无服务器应用是最令人兴奋的创新之一（当然是在容器之后）。图1.5显示了如何在单个Docker集群上运行所有应用程序-旧式单体应用，新的云原生应用程序和无服务器应用，这些集群可以在云或数据中心中运行：

 **图1.5运行Docker的单个服务器集群可以运行每种类型的应用程序，并且无论它们使用哪种架构或技术堆栈，都可以以相同的方式构建，部署和管理它们**

![img](https://dpzbhybb2pdcj.cloudfront.net/stoneman/v-7/Figures/Images_01-03_5.jpg)

无服务器应用主要是关于容器的。无服务器的目标是使开发人员专注于编写函数代码，然后将其推送到仓库成为服务，通过该服务构建并打包代码。当使用者使用该功能时，服务将启动该功能的实例以对请求进行操作。不需要构建服务器，管理生产服务器，所有这些都由平台负责。

在背后，所有无服务器架构都使用Docker打包代码，并使用容器运行功能。但是云中的函数不可移植–您无法使用AWS Lambda编写函数并在Azure中运行它，因为无服务器架构没有统一开放的标准。如果您希望无服务器应用不被某个云服务厂商锁定，或者您正在自己的数据中心中运行，则可以使用Nuclio，OpenFaaS或Fn Project在Docker中托管自己的平台，这些都是流行的开源无服务器框架。

机器学习，区块链和物联网等其他重大创新都受益于Docker一致的打包和部署模型。您会发现所有部署到Docker Hub的主要项目-TensorFlow和Hyperledger是很好的例子。物联网特别有趣，因为Docker与Arm合作使容器成为边缘和物联网设备的默认运行时环境。

### 1.1.5 DevOps-数字化转型

以上几个场景都与技术有关，但对许多大型和老式企业而言，面临的最大问题是组织。团队被分为“开发人员”和“运维人员”，分别负责项目生命周期的不同部分。发布时出现的问题通常演变为"甩锅大战"，并且为了防止将来的故障设置了很多的质量门。最终，您一年只能管理两、三个发布，而且它们是高风险且劳动密集型的。

DevOps的目标是让一个团队拥有整个应用程序生命周期，将“dev”和“ ops”组合为一个可交付成果，从而为软件部署和维护带来敏捷性。DevOps主要是关于组织文化变革的，它确实可以使组织实现从庞大的季度发布到小型的每日部署。但是，不更改团队使用的技术很难做到这一点。

运维人员可能具有Bash，Nagios，PowerShell和System Center等工具的背景。开发人员在Make，Maven，NuGet和MSBuild中工作。当他们不使用通用技术时很难组建团队，这正是Docker能提供的帮助。您可以通过将应用迁移至容器来支持DevOps转换，突然间，整个团队都在使用Dockerfiles和Docker Compose文件，使用相同的语言，相同的工具。

DevOps能走得更远。有一个用于实施DevOps的强大框架，称为CALMS –文化，自动化，精益，指标和共享。Docker致力于所有这些举措：自动化是运行容器的核心，分布式应用程序是基于精益原则、基于应用的指标、基于可轻松发布生产应用程序的流程、基于Docker Hub是共享而不是重复来构建的。

## 1.2 这本书适合你吗？

我概述的五个场景涵盖了IT行业目前正在发生的几乎所有变化，很明显Docker是这一切的关键。如果您想让Docker解决这类现实问题，这本书非常适合您。它使您零基础实现在生产级集群上的容器中运行应用程序。

本书的目的是教您如何使用Docker，因此，我不会过多地介绍Docker本身是如何工作的。我不会详细介绍 `containerd` 或讨论诸如Linux `cgroups` 和 `/namespaces` 或 Windows Host Compute Service 之类的底层细节。如果您需要了解内部实现原理，[Manning](https://www.manning.com/) 的Docker in Action是一个不错的选择。

本书中的示例都是跨平台的，因此您可以使用Windows，Mac或Linux（包括Arm处理器）一起工作，因此也可以使用Raspberry Pi。我使用不同的编程语言，但仅使用跨平台的语言，因此我使用.NET Core而不是.NET Framework（仅在Windows上运行）。如果您想深入学习Windows容器，欢迎访问我的博客。

最后，这本书专门针对Docker –因此，在生产部署方面，我将使用Docker Swarm，这是Docker内置的集群技术。在第12章中，我将讨论Kubernetes以及如何在Swarm和Kubernetes之间进行选择，但是我不会在Kubernetes上进行详细介绍。Kubernetes本身需要另外一个多月的午餐时间来学习，Kubernetes是运行Docker容器的另一种方式，因此您在本书中学到的所有内容都适用。

## 1.3 如何使用这本书？

本书遵循一个月午餐时间的原则：您应该能够在一个小时内完成每一章的工作，并且可以在一个月内完成整本书的学习。“工作”是这里的关键词，因为每天60分钟应该有足够的时间阅读本章，通过 立即尝试练习 进行工作，并动手练习。将容器化融入你的工作中，可以巩固您在每一章中获得的知识。

### 1.3.1 学习历程

Docker是一种很棒的教学技术，因为您可以轻松地建立一条清晰的学习路径，从简单开始，逐步添加越来越多的东西，直到投入生产为止。本书总结了我在数十个研讨会，网络研讨会和培训课程中积累的可靠经验。

第2章至第6章介绍了基础知识。在这里，您将学习如何运行容器，如何为Docker打包应用程序以及如何在Docker Hub和其他服务器上共享它们。您还将了解容器中的存储，以及如何在Docker中处理有状态应用程序（例如数据库）。

第7章至第11章介绍在容器中运行分布式应用程序，其中每个组件运行在通过虚拟Docker网络连接的容器中。在这里，您将学习Docker Compose模式，以使您的容器化应用程序可以投入生产，包括运行状况检查和监控。本节还介绍了在环境之间迁移应用程序以及使用Docker构建CI流程。

第12章至第16章是关于使用容器编排运行分布式应用程序的信息，容器编排是一组运行Docker的机器集群。您将学习将服务器连接在一起的知识，并扩展对Docker Compose的了解，以在集群上部署应用程序。您还将学习如何构建跨平台的Docker容器，以便它们在Windows，Linux，Intel和Arm上运行。可移植性是Docker的关键特性，相比云服务费用更低，处理更高效来说，它将变得越来越重要。

第17至21章涵盖了更高级的主题。这时应用具备上生产的条件，会给出一些Docker容器的优化建议，以及将应用程序的日志和配置集成到Docker平台的模式。这也包括使用强大的通信模式将应用程序分解为多个容器的方法：反向代理和消息队列。

最后一章提供了有关继续学习Docker的指南-结合理论验证 以将您自己的应用程序迁移到Docker，以及如何让感兴趣的成员加入组织中，并规划您的生产流程。在本书的最后，您应该有信心将Docker纳入您的日常工作。

### 1.3.2 立即尝试

本书的每一章都有指导性的练习供您完成。本书的源代码全部在GitHub上的[https://github.com/sixeyed/diamol](https://github.com/sixeyed/diamol) 当设置好实验环境，可以从GitHub上把这个仓库克隆下来，该仓库包含可用于构建和在容器中运行应用程序的示例命令。

许多章节以本书前面的内容为基础，但是您无需按顺序阅读所有章节。通过练习，您将打包在Docker中运行的应用程序，但是我已经打包了所有应用程序，并在Docker Hub上发布了它们。这意味着您可以在任何阶段使用我的打包应用程序。

如果您能抽时间来研究本书中的所有示例，那么与仅仅浏览各章并运行最终的示例应用程序相比，从本书中可以获得更多的收益:)

### 1.3.3 动手练习

每章都以动手实验结束，邀请您进一步“立即尝试”练习。这些练习不需要指导–您可能会获得一些说明和提示，最主要需要由您来完成实验。`sixeyed/diamol` GitHub存储库中有所有实验的示例答案，因此您可以检查自己是如何完成的，另外如果您没有时间参加其中一个实验，可以看看我是如何完成的。

### 1.3.4 其他资源

除本书外深入探讨Docker相关问题的地方是Docker自己的文档[docs.docker.com](http://docs.docker.com/)，内容涵盖了从设置Docker引擎（通过Dockerfiles和Docker Compose的语法）到Docker Swarm和Docker的Enterprise产品相关的所有内容。

## 1.4 创建实验环境

现在我们开始吧。您要遵循的所有内容只有Docker及其示例的源代码。

### 1.4.1 安装Docker

免费的Docker社区版非常适合开发甚至可以用于生产。如果您运行的是Windows 10或Mac OS X的最新版本，最好的选择是Docker Desktop。较旧的版本可以使用Docker Toolbox。Docker还为所有主要的Linux发行版提供安装软件包。选择最适合您的方式安装Docker。

#### 在Windows 10上安装Docker Desktop

您需要Windows 10专业版或企业版才能使用Docker桌面，并且确保已安装所有Windows更新-您至少应安装了发行版`1809`（从命令行运行`winver` 以检查您的版本）。浏览https://www.docker.com/products/docker-desktop并选择安装稳定版本。下载安装程序并运行它，接受所有默认设置。当Docker Desktop运行时，您将在Windows时钟附近的任务栏中看到Docker的鲸鱼图标。

#### 在Mac OS X上安装Docker Desktop

您需要OS X Sierra 10.12或更高版本才能使用Mac的Docker桌面-单击菜单栏左上方的Apple图标，然后选择*关于本机以查看您的版本。浏览https://www.docker.com/products/docker-desktop并选择安装稳定版本。下载安装程序并运行它，接受所有默认设置。当Docker Desktop运行时，您将在时钟附近的Mac菜单栏中看到Docker的鲸鱼图标。

#### 安装Docker Toolbox

如果您使用的是Windows或OS X的旧版本，则可以使用Docker Toolbox。Docker的最终体验是一样的，但底层还有更多内容。浏览https://docs.docker.com/toolbox  并按照说明进行操作–您需要首先设置Virtual Machine，例如VirtualBox（如果可以使用Docker Desktop，则它是一个更好的选择，因为您不可以使用它）需要单独的VM管理器）。

#### 安装Docker Community Edition和Docker Compose

如果您正在运行Linux，则您的发行版可能附带了可以安装的Docker版本，但您不想使用它。这可能是Docker的一个旧版本，由于Docker团队现在提供了自己的安装软件包。在非生产环境中您可以使用更新脚本来更新Docker的每个新版本-浏览https://get.docker.com](https://get.docker.com/)并按照说明运行脚本。

#### 在Windows Server或Linux Server发行版上安装Docker

Docker社区版可以部署到生产，但是如果您想运行获得支持的容器，则可以使用Docker提供的商业版本，称为Docker Enterprise。Docker Enterprise建立在Community Edition的基础上，因此您在本书中学习的所有内容都可以与Docker Enterprise一起使用。有适用于所有主要Linux发行版以及Windows Server 2016和2019的版本。您可以在https://hub.docker.com/search/?q=&type=edition&offering=enterprise上找到所有Docker Enterprise版本以及Docker Hub上的安装说明。

### 1.4.2 验证Docker安装

Docker平台由多个组件组成，但是对于这本书而言，您只需要验证Docker是否正常运行并且已安装Docker Compose。

首先使用以下`docker version` 命令检查Docker本身：

```powershell
$ docker version
Client: Docker Engine - Community
 Version:           19.03.5
 API version:       1.40
 Go version:        go1.12.12
 Git commit:        633a0ea
 Built:             Wed Nov 13 07:22:34 2019
 OS/Arch:           darwin/amd64
 Experimental:      true

Server: Docker Engine - Community
 Engine:
  Version:          19.03.5
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.12.12
  Git commit:       633a0ea
  Built:            Wed Nov 13 07:29:19 2019
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          v1.2.10
  GitCommit:        b34a5c8af56e510852c35414db4c1f4fa6172339
 runc:
  Version:          1.0.0-rc8+dev
  GitCommit:        3e425f80a8c931f88e6d94a8c831b9d5aa481657
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683
```

您的输出可能与我的输出不同，因为版本会发生变化，并且您使用的可能是其他操作系统-但是只要您能看到Client和Server的版本号，就表示Docker已经正常工作。不必担心什么是客户端和服务器，您将在下一章中了解Docker的体系结构。

接下来，您需要测试Docker Compose，这也是一个与Docker交互的命令，运行`docker-compose version` 检查：

```powershell
$ docker-compose version
docker-compose version 1.25.4, build 8d51620a
docker-py version: 4.1.0
CPython version: 3.7.5
OpenSSL version: OpenSSL 1.1.1d  10 Sep 2019
```

同样，您的输出可能与我的输出不同，但是只要获得没有错误的版本列表，您就可以使用了。

### 1.4.3下载该书的源代码

本书的源代码位于GitHub上的公共Git存储库中。如果您安装了Git客户端，请运行：

```powershell
git clone https://github.com/sixeyed/diamol.git
```

如果您没有安装Git客户端，请浏览[https://github.com/sixeyed/diamol](http://github.com/sixeyed/diamol)并单击“克隆或下载”按钮，将源代码的ZIP文件下载到本地计算机，然后展开存档。

## 1.5 立即生效

“立即生效”是一个月午餐时间学习系列的另一个原则。在接下来的所有章节中，重点都是学习技能并将其付诸实践。

每章都以对该主题的简短介绍开始，然后立即实践，在其中您可以使用Docker将这些想法付诸实践。然后有一个更详细的概述，用以说明您在深入研究过程中可能遇到的一些问题，最后是一个动手实验，完成后您可以进入下一个阶段。

所有主题都围绕在现实世界中真正有用的任务。在本章中，您将学习如何立即有效地使用该主题，并通过了解如何应用这项新技能来结束本教程。让我们开始运行容器！